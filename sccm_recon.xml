<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="SCCMRecon">
    <SCCMTask/>
  </Target>
  
  <UsingTask TaskName="SCCMTask" TaskFactory="CodeTaskFactory" 
             AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll">
    <Task>
      <Code Type="Class" Language="cs">
        <![CDATA[
        using System;
        using Microsoft.Build.Framework;
        using Microsoft.Build.Utilities;
        using Microsoft.Win32;
        
        public class SCCMTask : Task
        {
            private const string SCCM_BASE = @"SOFTWARE\Microsoft\SMS";
            
            public override bool Execute()
            {
                Console.Write("Enter hostname: ");
                string host = Console.ReadLine();
                
                if (string.IsNullOrWhiteSpace(host))
                {
                    Console.WriteLine("[-] No hostname provided");
                    return false;
                }
                
                try
                {
                    Console.WriteLine("[*] Connecting to " + host + " as " + Environment.UserDomainName + "\\" + Environment.UserName);
                    EnumerateHost(host);
                }
                catch (Exception ex)
                {
                    Console.WriteLine("[-] Error: " + ex.Message);
                }
                
                return true;
            }
            
            private void EnumerateHost(string host)
            {
                try
                {
                    using (RegistryKey remoteReg = RegistryKey.OpenRemoteBaseKey(RegistryHive.LocalMachine, host))
                    {
                        EnumeratePSSRoles(remoteReg);
                        EnumerateSiteDB(remoteReg);
                    }
                }
                catch (UnauthorizedAccessException)
                {
                    Console.WriteLine("[-] Access denied. Current user lacks permissions to access the remote registry.");
                }
                catch (System.IO.IOException ex)
                {
                    Console.WriteLine("[-] Network error: " + ex.Message);
                    Console.WriteLine("[-] Ensure Remote Registry service is running on target");
                }
            }
            
            private void EnumeratePSSRoles(RegistryKey remoteReg)
            {
                try
                {
                    using (RegistryKey smsKey = remoteReg.OpenSubKey(SCCM_BASE))
                    {
                        if (smsKey == null)
                        {
                            Console.WriteLine("[-] SCCM installation not found");
                            return;
                        }
                        
                        string[] subKeys = smsKey.GetSubKeyNames();
                        
                        foreach (string subKey in subKeys)
                        {
                            if (subKey.Equals("DP", StringComparison.OrdinalIgnoreCase))
                            {
                                Console.WriteLine("[+] Distribution Point Installed");
                                EnumerateDP(remoteReg);
                            }
                            
                            if (subKey.Equals("MP", StringComparison.OrdinalIgnoreCase))
                            {
                                Console.WriteLine("[+] Management Point Installed");
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine("[-] Error enumerating PSS roles: " + ex.Message);
                }
            }
            
            private void EnumerateDP(RegistryKey remoteReg)
            {
                try
                {
                    string dpPath = SCCM_BASE + @"\DP";
                    using (RegistryKey dpKey = remoteReg.OpenSubKey(dpPath))
                    {
                        if (dpKey == null) return;
                        
                        string siteCode = dpKey.GetValue("SiteCode") as string;
                        if (!string.IsNullOrEmpty(siteCode))
                            Console.WriteLine("[+] Site Code Found: " + siteCode);
                        
                        string siteServer = dpKey.GetValue("SiteServer") as string;
                        if (!string.IsNullOrEmpty(siteServer))
                            Console.WriteLine("[+] Site Server Found: " + siteServer);
                        
                        string managementPoints = dpKey.GetValue("ManagementPoints") as string;
                        if (!string.IsNullOrEmpty(managementPoints))
                        {
                            string[] mps = managementPoints.Split(new char[] { '*' }, StringSplitOptions.RemoveEmptyEntries);
                            foreach (string mp in mps)
                            {
                                if (!string.IsNullOrWhiteSpace(mp))
                                    Console.WriteLine("[+] Management Point Found: " + mp);
                            }
                        }
                        
                        object isAnon = dpKey.GetValue("IsAnonymousAccessEnabled");
                        if (isAnon != null && Convert.ToInt32(isAnon) == 1)
                            Console.WriteLine("[+] Anonymous Access On This Distribution Point Is Enabled");
                        
                        object isPXE = dpKey.GetValue("IsPXE");
                        if (isPXE != null && Convert.ToInt32(isPXE) == 1)
                            Console.WriteLine("[+] PXE Installed");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine("[-] Error enumerating DP: " + ex.Message);
                }
            }
            
            private void EnumerateSiteDB(RegistryKey remoteReg)
            {
                try
                {
                    string dbPath = SCCM_BASE + @"\COMPONENTS\SMS_SITE_COMPONENT_MANAGER\Multisite Component Servers";
                    using (RegistryKey dbKey = remoteReg.OpenSubKey(dbPath))
                    {
                        if (dbKey == null)
                        {
                            Console.WriteLine("[+] Site Database is Local to the Primary Site Server");
                            return;
                        }
                        
                        string[] subKeys = dbKey.GetSubKeyNames();
                        
                        if (subKeys.Length == 1)
                            Console.WriteLine("[+] Site Database Found: " + subKeys[0]);
                        else if (subKeys.Length == 0)
                            Console.WriteLine("[+] Site Database is Local to the Primary Site Server");
                        else
                        {
                            foreach (string server in subKeys)
                                Console.WriteLine("[+] Multisite Component Server: " + server);
                        }
                    }
                }
                catch (Exception)
                {
                    Console.WriteLine("[+] Site Database is Local to the Primary Site Server");
                }
            }
        }
        ]]>
      </Code>
    </Task>
  </UsingTask>
</Project>
